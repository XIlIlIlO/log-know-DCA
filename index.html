<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Trading Analysis - Log Parser (Deep Fix + StopLoss)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root {
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-border: #e0e0e0;
            --color-primary: #2196F3;
            --color-success: #4caf50;
            --color-error: #f44336;
            --color-sl: #e91e63; /* ÏÜêÏ†à ÌëúÏãúÏö© ÏÉâÏÉÅ */
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 40px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .subtitle {
            color: #666;
            font-size: 14px;
        }

        .upload-section {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 40px 20px;
            margin-bottom: 30px;
            border: 2px dashed var(--color-border);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--color-primary);
            background-color: #f9f9f9;
        }

        .upload-section.dragover {
            background-color: #e3f2fd;
            border-color: var(--color-primary);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--color-text);
        }

        .upload-hint {
            font-size: 13px;
            color: #999;
            margin-bottom: 20px;
        }

        #fileInput {
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 10px 24px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background-color: var(--color-primary);
            color: white;
            margin: 0 8px;
        }

        .btn-primary:hover {
            background-color: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }

        .btn-secondary {
            background-color: var(--color-success);
            color: white;
        }

        .btn-secondary:hover {
            background-color: #45a049;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .file-list {
            margin-top: 20px;
            padding: 15px;
            background-color: #f9f9f9;
            border-radius: 6px;
            display: none;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid var(--color-border);
            font-size: 13px;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            color: var(--color-text);
            font-weight: 500;
        }

        .file-size {
            color: #999;
            font-size: 12px;
        }

        .remove-file {
            color: var(--color-error);
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .remove-file:hover {
            background-color: rgba(244, 67, 54, 0.1);
        }

        .results-section {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-border);
        }

        .results-title {
            font-size: 20px;
            font-weight: 600;
        }

        .stats {
            display: flex;
            gap: 30px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            flex: 1;
            min-width: 150px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--color-primary);
        }

        .stat-value.sl-value {
            color: var(--color-sl);
        }

        .table-container {
            overflow-x: auto;
            border-radius: 6px;
            border: 1px solid var(--color-border);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th {
            background-color: #f5f5f5;
            padding: 12px 10px;
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            border: 1px solid var(--color-border);
            color: var(--color-text);
            white-space: nowrap;
        }

        th:first-child {
            text-align: left;
            background-color: #eeeeee;
            min-width: 150px;
        }

        td {
            padding: 12px 10px;
            text-align: center;
            border: 1px solid var(--color-border);
            font-size: 13px;
            font-weight: 500;
        }

        td:first-child {
            text-align: left;
            background-color: #fafafa;
            font-weight: 600;
            color: var(--color-text);
        }

        .color-cell {
            color: white;
            font-weight: 600;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .color-legend {
            margin-top: 30px;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 6px;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .legend-bar {
            height: 20px;
            border-radius: 4px;
            background: linear-gradient(to right, 
                #c8e6c9 0%, 
                #a5d6a7 20%, 
                #81c784 40%, 
                #ffd54f 60%, 
                #ffb74d 75%, 
                #ef5350 90%, 
                #c62828 100%);
            margin-bottom: 10px;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }

        .error-message {
            background-color: #ffebee;
            border: 1px solid #ef5350;
            color: #c62828;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            background-color: #e8f5e9;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
            display: none;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--color-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .progress-text {
            margin-top: 10px;
            font-size: 14px;
            font-weight: 500;
            color: var(--color-primary);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .footer {
            text-align: center;
            color: #999;
            font-size: 12px;
            margin-top: 50px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 10px;
            }

            h1 {
                font-size: 22px;
            }

            .results-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .stats {
                gap: 15px;
            }

            table {
                font-size: 12px;
            }

            th, td {
                padding: 8px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä DCA Trading Analysis</h1>
            <p class="subtitle">Log ÌååÏùºÏùÑ ÏóÖÎ°úÎìúÌïòÏó¨ DCA ÏùµÏ†à Î∞è ÏÜêÏ†à ÌòÑÌô©ÏùÑ Î∂ÑÏÑùÌïòÏÑ∏Ïöî (ÎåÄÏö©Îüâ ÏßÄÏõê)</p>
        </header>

        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">üìÅ</div>
            <div class="upload-text">Ïó¨Í∏∞Ïóê ÌååÏùºÏùÑ ÎìúÎûòÍ∑∏ÌïòÍ±∞ÎÇò ÌÅ¥Î¶≠ÌïòÏó¨ ÏóÖÎ°úÎìú</div>
            <div class="upload-hint">ÏßÄÏõê ÌòïÏãù: .log, .txt (ÎåÄÏö©Îüâ ÌååÏùº ÏßÄÏõê)</div>
            <button class="btn btn-primary" id="selectFileBtn">
                ÌååÏùº ÏÑ†ÌÉù
            </button>
            <input type="file" id="fileInput" multiple accept=".log,.txt">
        </div>

        <div class="file-list" id="fileList">
            <div style="font-weight: 600; margin-bottom: 10px;">ÏÑ†ÌÉùÎêú ÌååÏùº:</div>
            <div id="fileItems"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ï§ë...</p>
            <div class="progress-text" id="progressText">0%</div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-title">Î∂ÑÏÑù Í≤∞Í≥º</div>
                <button class="btn btn-secondary" id="exportBtn">
                    üì• ExcelÎ°ú Îã§Ïö¥Î°úÎìú
                </button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">Ï¥ù ÏùµÏ†à ÌöüÏàò</div>
                    <div class="stat-value" id="totalTakeProfit">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ï¥ù ÏÜêÏ†à ÌöüÏàò</div>
                    <div class="stat-value sl-value" id="totalStopLoss">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ï¥ù Í∑∏Î£π Ïàò</div>
                    <div class="stat-value" id="totalGroups">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÌèâÍ∑† DCA Îã®Í≥Ñ</div>
                    <div class="stat-value" id="avgDCAStep">0</div>
                </div>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead id="tableHead">
                    </thead>
                    <tbody id="tableBody">
                    </tbody>
                </table>
            </div>

            <div class="color-legend">
                <div class="legend-title">ÏÉâÏÉÅ Î≤îÎ°Ä (ÏùµÏ†à ÌöüÏàò Í∏∞Î∞ò)</div>
                <div class="legend-bar"></div>
                <div class="legend-labels">
                    <span>ÏµúÏÜå</span>
                    <span>ÎÇÆÏùå</span>
                    <span>Ï§ëÍ∞Ñ</span>
                    <span>ÎÜíÏùå</span>
                    <span>ÏµúÎåÄ</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>¬© 2026 DCA Trading Analysis Tool | GitHub Pages</p>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let mergedGroupMap = {}; 
        let mergedStopLossMap = {}; // ÏÜêÏ†à Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•Ïö© Îßµ
        let currentMaxDCA = 0;
        let currentTotalProfitCount = 0;
        let currentTotalStopLossCount = 0;
        let currentTotalDcaSum = 0;
        
        const CHUNK_SIZE = 5 * 1024 * 1024; 

        // ==========================================
        // UI Ïù¥Î≤§Ìä∏ Ìï∏Îì§ÎßÅ
        // ==========================================
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');

        selectFileBtn.addEventListener('click', () => fileInput.click());

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateFileList();

            if (selectedFiles.length > 0) {
                setTimeout(() => {
                    analyzeFiles();
                }, 300);
            }
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');

            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }

            fileList.style.display = 'block';
            fileItems.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <div class="remove-file" onclick="removeFile(${index})">Ï†úÍ±∞</div>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            if (selectedFiles.length === 0) {
                document.getElementById('resultsSection').style.display = 'none';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = '‚ùå ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = '‚úÖ ' + message;
            successDiv.style.display = 'block';
            setTimeout(() => {
                successDiv.style.display = 'none';
            }, 3000);
        }

        // ==========================================
        // ÌïµÏã¨ Î°úÏßÅ ÏàòÏ†ï: Î°úÍ∑∏ ÌååÏã± (ÏÜêÏ†à Ìè¨Ìï®)
        // ==========================================
        
        class StreamDcaParser {
            constructor() {
                // 1. PROFIT Ï∂îÏ∂ú Ï†ïÍ∑úÏãù (Í∏∞Ï°¥)
                this.profitRegex = /PROFIT\s+\[.*?\](?:(?!PROFIT)[\s\S])*?-\s*GROUP\s*:\s*(.*?)(?:\s+-\s+|[\r\n])(?:(?!PROFIT)[\s\S])*?-\s*DCA\s*:\s*(\d+)/g;
                
                // 2. STOP LOSS (Backtest Report) Ï∂îÏ∂ú Ï†ïÍ∑úÏãù (Ïã†Í∑ú)
                // [Backtest Report] Î∏îÎ°ù ÎÇ¥Ïùò Group NameÍ≥º Ï¥ù ÏÜêÏ†à ÌöåÏàòÎ•º Ï∞æÏäµÎãàÎã§.
                // Group Name Ïù¥ÌõÑÏóê "Ï¥ù ÏÜêÏ†à ÌöåÏàò"Í∞Ä ÎÇòÏò§Í∏∞ Ï†ÑÍπåÏßÄ Îã§Î•∏ Group NameÏù¥ ÎÇòÏò§ÏßÄ ÏïäÎèÑÎ°ù Ï≤òÎ¶¨Ìï©ÎãàÎã§.
                this.slRegex = /Group Name\s*:\s*(.*?)(?:[\r\n]+)(?:(?!Group Name)[\s\S])*?Ï¥ù ÏÜêÏ†à ÌöåÏàò\s*:\s*(\d+)/g;
                
                this.buffer = "";
            }

            processChunk(chunk) {
                this.buffer += chunk;
                
                // --- A. PROFIT Ï≤òÎ¶¨ ---
                let match;
                let lastProfitIndex = 0;

                this.profitRegex.lastIndex = 0;
                while ((match = this.profitRegex.exec(this.buffer)) !== null) {
                    const groupName = match[1].trim();
                    const dcaStep = parseInt(match[2]);

                    if (!mergedGroupMap[groupName]) {
                        mergedGroupMap[groupName] = {};
                    }
                    if (!mergedGroupMap[groupName][dcaStep]) {
                        mergedGroupMap[groupName][dcaStep] = 0;
                    }
                    
                    mergedGroupMap[groupName][dcaStep]++;
                    
                    if (dcaStep > currentMaxDCA) currentMaxDCA = dcaStep;
                    currentTotalProfitCount++;
                    currentTotalDcaSum += dcaStep;

                    lastProfitIndex = this.profitRegex.lastIndex;
                }

                // --- B. STOP LOSS Ï≤òÎ¶¨ ---
                let slMatch;
                let lastSlIndex = 0;
                
                this.slRegex.lastIndex = 0;
                while ((slMatch = this.slRegex.exec(this.buffer)) !== null) {
                    const groupName = slMatch[1].trim();
                    const slCount = parseInt(slMatch[2]);

                    // ÏÜêÏ†à ÌöüÏàò ÎàÑÏ†Å
                    if (!mergedStopLossMap[groupName]) {
                        mergedStopLossMap[groupName] = 0;
                    }
                    // Î°úÍ∑∏ ÌååÏùº ÎÇ¥ Î≥¥Í≥†ÏÑúÍ∞Ä ÎàÑÏ†ÅÍ∞íÏù¥ ÏïÑÎãå Í∞úÎ≥Ñ Î≥¥Í≥†ÏÑúÏùº Í≤ΩÏö∞Î•º Í∞ÄÏ†ïÌïòÏó¨ Í∞íÏùÑ ÎçîÌï®
                    mergedStopLossMap[groupName] += slCount;
                    currentTotalStopLossCount += slCount;

                    lastSlIndex = this.slRegex.lastIndex;
                }

                // --- C. Î≤ÑÌçº Ï†ïÎ¶¨ ---
                // Îëê Ï†ïÍ∑úÏãù Ï§ë Îçî Î©ÄÎ¶¨ ÏßÑÌñâÎêú Ïù∏Îç±Ïä§Î•º Í∏∞Ï§ÄÏúºÎ°ú ÏûêÎ•¥Îêò, 
                // ÏïÑÏßÅ Ï≤òÎ¶¨ÎêòÏßÄ ÏïäÏùÄ Ìå®ÌÑ¥Ïù¥ ÏûòÎ¶¨ÏßÄ ÏïäÎèÑÎ°ù Ï£ºÏùòÌï¥Ïïº Ìï©ÎãàÎã§.
                // ÏïàÏ†ÑÏùÑ ÏúÑÌï¥, ÌôïÏã§Ìûà Ï≤òÎ¶¨Îêú Î∂ÄÎ∂Ñ(ÏµúÎåìÍ∞í)ÍπåÏßÄ ÏûêÎ•¥Îêò, 
                // ÎßåÏïΩ ÌïúÏ™Ω Ìå®ÌÑ¥Ïù¥ ÏïÑÏòà Î∞úÍ≤¨ÎêòÏßÄ ÏïäÏïòÎã§Î©¥(Ïù∏Îç±Ïä§ 0), Î∞úÍ≤¨Îêú Ï™Ω Í∏∞Ï§ÄÏúºÎ°úÎßå ÏûêÎ¶ÖÎãàÎã§.
                
                const sliceIndex = Math.max(lastProfitIndex, lastSlIndex);

                // Ï≤òÎ¶¨Îêú Î∂ÄÎ∂Ñ ÏûòÎùºÎÇ¥Í∏∞
                if (sliceIndex > 0) {
                    this.buffer = this.buffer.slice(sliceIndex);
                }
                
                // ÎπÑÏ†ïÏÉÅÏ†ÅÏúºÎ°ú Î≤ÑÌçºÍ∞Ä Ïª§Ïßà Í≤ΩÏö∞ Í∞ïÏ†ú Ï†ïÎ¶¨ (Î¨¥Ìïú Î£®ÌîÑ Î∞©ÏßÄ)
                if (this.buffer.length > 10 * 1024 * 1024) {
                   // ÏûÑÏãú Î∞©Ìé∏: Í∞ÄÏû• ÎßàÏßÄÎßâÏóê Î∞úÍ≤¨Îêú ÌÇ§ÏõåÎìú Í∏∞Ï§ÄÏúºÎ°ú ÏûêÎ¶Ñ
                   const lastKeyword = Math.max(this.buffer.lastIndexOf("PROFIT"), this.buffer.lastIndexOf("Backtest Report"));
                   if (lastKeyword > -1) {
                       this.buffer = this.buffer.slice(lastKeyword);
                   } else {
                       this.buffer = ""; 
                   }
                }
            }
        }

        function analyzeFiles() {
            mergedGroupMap = {};
            mergedStopLossMap = {}; // Ï¥àÍ∏∞Ìôî
            currentMaxDCA = 0;
            currentTotalProfitCount = 0;
            currentTotalStopLossCount = 0;
            currentTotalDcaSum = 0;

            const loading = document.getElementById('loading');
            const progressText = document.getElementById('progressText');
            loading.style.display = 'block';
            
            let filesProcessed = 0;
            const totalFiles = selectedFiles.length;

            const processNextFile = (fileIndex) => {
                if (fileIndex >= totalFiles) {
                    finishAnalysis();
                    return;
                }

                const file = selectedFiles[fileIndex];
                const fileSize = file.size;
                let offset = 0;
                
                let parser = new StreamDcaParser();
                let chunkReader = new FileReader();

                chunkReader.onload = function(e) {
                    const chunkText = e.target.result;
                    parser.processChunk(chunkText);
                    e.target.result = null; 
                    
                    offset += CHUNK_SIZE;
                    
                    const percent = Math.min(100, Math.round((offset / fileSize) * 100));
                    const totalPercent = Math.round(((fileIndex * 100) + percent) / totalFiles);
                    progressText.innerText = `${totalPercent}% (ÌååÏùº ${fileIndex + 1}/${totalFiles} Ï≤òÎ¶¨ Ï§ë)`;

                    if (offset < fileSize) {
                        setTimeout(readNextChunk, 0);
                    } else {
                        parser = null;
                        chunkReader = null;
                        filesProcessed++;
                        setTimeout(() => processNextFile(fileIndex + 1), 10);
                    }
                };

                chunkReader.onerror = function() {
                    console.error("Read Error", file.name);
                    showError(`${file.name} ÏùΩÍ∏∞ Ïã§Ìå®`);
                    document.getElementById('loading').style.display = 'none';
                };

                function readNextChunk() {
                    const slice = file.slice(offset, offset + CHUNK_SIZE);
                    chunkReader.readAsText(slice, 'UTF-8');
                }

                readNextChunk();
            };

            processNextFile(0);
        }

        function finishAnalysis() {
            document.getElementById('loading').style.display = 'none';

            if (currentTotalProfitCount === 0 && currentTotalStopLossCount === 0) {
                showError('Î∂ÑÏÑùÌï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. Î°úÍ∑∏ ÌååÏùº ÌòïÏãùÏùÑ ÌôïÏù∏ÌïòÏÑ∏Ïöî.');
                return;
            }

            renderResults();
            showSuccess(`${selectedFiles.length}Í∞ú ÌååÏùº Î∂ÑÏÑù ÏôÑÎ£å!`);
        }

        function getCommonColor(value, minVal, maxVal) {
            if (value === 0) return { hex: 'CCCCCC', rgb: 'rgba(200, 200, 200, 0.3)' };
            if (minVal === maxVal) return { hex: 'EF5350', rgb: '#ef5350' };

            const logMin = Math.log(minVal + 1);
            const logMax = Math.log(maxVal + 1);
            const logVal = Math.log(value + 1);
            const normalizedValue = (logVal - logMin) / (logMax - logMin);

            let r, g, b;
            if (normalizedValue < 0.3) {
                const t = normalizedValue / 0.3;
                r = Math.round(165 + (255 - 165) * t);
                g = 214;
                b = Math.round(167 + (79 - 167) * t);
            } else if (normalizedValue < 0.7) {
                const t = (normalizedValue - 0.3) / 0.4;
                r = 255;
                g = Math.round(214 + (180 - 214) * t);
                b = Math.round(79 + (0 - 79) * t);
            } else {
                const t = (normalizedValue - 0.7) / 0.3;
                r = 255;
                g = Math.round(180 + (0 - 180) * t);
                b = 0;
            }

            const toHex = (c) => c.toString(16).padStart(2, '0').toUpperCase();
            return {
                hex: `${toHex(r)}${toHex(g)}${toHex(b)}`,
                rgb: `rgb(${r}, ${g}, ${b})`
            };
        }

        function renderResults() {
            const groupMap = mergedGroupMap;
            const maxDCA = currentMaxDCA;
            
            // Í∑∏Î£π Îßµ ÌÇ§ + ÏÜêÏ†à Îßµ ÌÇ§ Ìï©ÏπòÍ∏∞ (ÌòπÏãú ÏùµÏ†àÏùÄ ÏóÜÍ≥† ÏÜêÏ†àÎßå ÏûàÎäî Í∑∏Î£πÏù¥ ÏûàÏùÑ Ïàò ÏûàÏúºÎØÄÎ°ú)
            const allGroups = new Set([...Object.keys(groupMap), ...Object.keys(mergedStopLossMap)]);
            const totalGroups = allGroups.size;
            
            const avgDCA = currentTotalProfitCount > 0 
                ? (currentTotalDcaSum / currentTotalProfitCount).toFixed(2) 
                : 0;

            document.getElementById('totalTakeProfit').textContent = currentTotalProfitCount.toLocaleString();
            document.getElementById('totalStopLoss').textContent = currentTotalStopLossCount.toLocaleString();
            document.getElementById('totalGroups').textContent = totalGroups.toLocaleString();
            document.getElementById('maxDCAStep').textContent = maxDCA;
            document.getElementById('avgDCAStep').textContent = avgDCA;

            generateTable(allGroups, groupMap, maxDCA);

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('fileList').style.display = 'none';
        }

        function generateTable(allGroupsSet, groupMap, maxDCA) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Ìó§Îçî ÏÉùÏÑ±
            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>Í∑∏Î£πÎ™Ö</th>';
            for (let i = 0; i <= maxDCA; i++) {
                const th = document.createElement('th');
                th.textContent = `${i} DCA`;
                headerRow.appendChild(th);
            }
            // Total Ìó§Îçî
            const thTotal = document.createElement('th');
            thTotal.textContent = 'Total';
            headerRow.appendChild(thTotal);

            // [Ï∂îÍ∞ÄÎê®] Stop Loss Ìó§Îçî
            const thSL = document.createElement('th');
            thSL.textContent = 'Stop Loss';
            thSL.style.color = '#c62828'; // Î∂âÏùÄÏÉâ Í∞ïÏ°∞
            headerRow.appendChild(thSL);

            thead.appendChild(headerRow);

            const allValues = [];
            const rows = [];
            
            allGroupsSet.forEach(group => {
                let rowTotal = 0;
                const rowData = [];
                // ÏùµÏ†à Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
                for (let i = 0; i <= maxDCA; i++) {
                    const value = (groupMap[group] && groupMap[group][i]) ? groupMap[group][i] : 0;
                    rowData.push(value);
                    rowTotal += value;
                    if (value > 0) allValues.push(value);
                }
                // ÏÜêÏ†à Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
                const stopLossCount = mergedStopLossMap[group] || 0;

                rows.push({ group, data: rowData, total: rowTotal, stopLoss: stopLossCount });
            });
            
            // Ï†ïÎ†¨: ÏùµÏ†à Ìï©Í≥Ñ ÎÇ¥Î¶ºÏ∞®Ïàú (ÎèôÏùºÌïòÎ©¥ ÏÜêÏ†à ÎÇ¥Î¶ºÏ∞®Ïàú)
            rows.sort((a, b) => {
                if (b.total !== a.total) return b.total - a.total;
                return b.stopLoss - a.stopLoss;
            });

            const minVal = allValues.length > 0 ? Math.min(...allValues) : 0;
            const maxVal = allValues.length > 0 ? Math.max(...allValues) : 0;

            const fragment = document.createDocumentFragment();

            rows.forEach(row => {
                const tr = document.createElement('tr');
                const tdGroup = document.createElement('td');
                tdGroup.textContent = row.group ? row.group : "(Ïïå Ïàò ÏóÜÏùå)";
                tr.appendChild(tdGroup);

                row.data.forEach(value => {
                    const td = document.createElement('td');
                    if (value > 0) {
                        const color = getCommonColor(value, minVal, maxVal);
                        td.classList.add('color-cell');
                        td.style.backgroundColor = color.rgb;
                        td.textContent = value;
                    } else {
                        td.textContent = '-';
                        td.style.color = '#ccc';
                    }
                    tr.appendChild(td);
                });

                // Total (ÏùµÏ†à Ìï©Í≥Ñ)
                const tdTotal = document.createElement('td');
                tdTotal.style.fontWeight = '700';
                tdTotal.style.backgroundColor = '#f0f0f0';
                tdTotal.textContent = row.total;
                tr.appendChild(tdTotal);

                // [Ï∂îÍ∞ÄÎê®] Stop Loss (ÏÜêÏ†à Ìï©Í≥Ñ)
                const tdSL = document.createElement('td');
                tdSL.style.fontWeight = '700';
                tdSL.style.backgroundColor = '#fff0f0'; // Ïó∞Ìïú Î∂âÏùÄ Î∞∞Í≤Ω
                tdSL.style.color = '#c62828'; // Î∂âÏùÄ Í∏ÄÏî®
                tdSL.textContent = row.stopLoss > 0 ? row.stopLoss : '-';
                tr.appendChild(tdSL);

                fragment.appendChild(tr);
            });

            tbody.appendChild(fragment);
        }

        async function exportToExcel() {
            if (Object.keys(mergedGroupMap).length === 0 && Object.keys(mergedStopLossMap).length === 0) {
                showError('ÎÇ¥Î≥¥ÎÇº Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('DCA Summary');

                // Ìó§Îçî Íµ¨ÏÑ±
                const headers = ['Í∑∏Î£πÎ™Ö'];
                for (let i = 0; i <= currentMaxDCA; i++) {
                    headers.push(`${i} DCA`);
                }
                headers.push('Total');
                headers.push('Stop Loss'); // [Ï∂îÍ∞ÄÎê®]

                const headerRow = worksheet.addRow(headers);
                headerRow.eachCell((cell) => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0E0E0' } };
                    cell.font = { bold: true, size: 11 };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                });
                
                // ÏÜêÏ†à Ìó§Îçî ÌäπÎ≥Ñ ÏÉâÏÉÅ
                const slHeaderCell = headerRow.getCell(headers.length);
                slHeaderCell.font = { bold: true, color: { argb: 'FFFF0000' } }; // Îπ®Í∞Ñ ÌÖçÏä§Ìä∏

                // Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                const allGroups = new Set([...Object.keys(mergedGroupMap), ...Object.keys(mergedStopLossMap)]);
                const allValues = [];
                const rows = [];
                
                allGroups.forEach(group => {
                    let rowTotal = 0;
                    const rowData = [];
                    for (let i = 0; i <= currentMaxDCA; i++) {
                        const value = (mergedGroupMap[group] && mergedGroupMap[group][i]) ? mergedGroupMap[group][i] : 0;
                        rowData.push(value);
                        rowTotal += value;
                        if (value > 0) allValues.push(value);
                    }
                    const stopLoss = mergedStopLossMap[group] || 0;
                    rows.push({ group, data: rowData, total: rowTotal, stopLoss: stopLoss });
                });
                
                rows.sort((a, b) => {
                    if (b.total !== a.total) return b.total - a.total;
                    return b.stopLoss - a.stopLoss;
                });

                const minVal = allValues.length > 0 ? Math.min(...allValues) : 0;
                const maxVal = allValues.length > 0 ? Math.max(...allValues) : 0;

                rows.forEach(rowData => {
                    // [Ï∂îÍ∞ÄÎê®] Stop Loss Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
                    const rowValues = [rowData.group || "(Ïïå Ïàò ÏóÜÏùå)", ...rowData.data, rowData.total, rowData.stopLoss];
                    const row = worksheet.addRow(rowValues);

                    row.eachCell((cell, colNumber) => {
                        cell.border = {
                            top: { style: 'thin' }, left: { style: 'thin' },
                            bottom: { style: 'thin' }, right: { style: 'thin' }
                        };
                        cell.alignment = { vertical: 'middle', horizontal: 'center' };

                        // Í∑∏Î£πÎ™Ö
                        if (colNumber === 1) {
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF9F9F9' } };
                            cell.alignment = { vertical: 'middle', horizontal: 'left' };
                        } 
                        // DCA Ïª¨ÎüºÎì§
                        else if (colNumber > 1 && colNumber <= headers.length - 2) {
                            const val = cell.value;
                            if (val > 0) {
                                const color = getCommonColor(val, minVal, maxVal);
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + color.hex } };
                                cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
                            } else {
                                cell.value = '-';
                                cell.font = { color: { argb: 'FFCCCCCC' } };
                            }
                        }
                        // Total Ïª¨Îüº
                        else if (colNumber === headers.length - 1) {
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                        }
                        // Stop Loss Ïª¨Îüº
                        else if (colNumber === headers.length) {
                             cell.font = { bold: true, color: { argb: 'FFC62828' } };
                             cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF0F0' } };
                             if (cell.value === 0) cell.value = '-';
                        }
                    });
                });

                worksheet.columns.forEach((column) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell) => {
                        const columnLength = cell.value ? cell.value.toString().length : 10;
                        if (columnLength > maxLength) maxLength = columnLength;
                    });
                    column.width = maxLength < 10 ? 10 : maxLength + 2;
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = `DCA_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
                anchor.click();
                window.URL.revokeObjectURL(url);

                showSuccess('Excel ÌååÏùºÏù¥ Îã§Ïö¥Î°úÎìúÎêòÏóàÏäµÎãàÎã§!');
            } catch (error) {
                console.error('Excel Export Error:', error);
                showError('Excel ÎÇ¥Î≥¥ÎÇ¥Í∏∞ Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
            }
        }

        document.getElementById('exportBtn').addEventListener('click', exportToExcel);
    </script>
</body>
</html>
