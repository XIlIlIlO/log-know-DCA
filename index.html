<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DCA Trading Analysis - Log Parser (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.4.0/exceljs.min.js"></script>
    <style>
        :root {
            --color-bg: #f5f5f5;
            --color-surface: #ffffff;
            --color-text: #1a1a1a;
            --color-border: #e0e0e0;
            --color-primary: #2196F3;
            --color-success: #4caf50;
            --color-error: #f44336;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-bg);
            color: var(--color-text);
            padding: 20px;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        header { text-align: center; margin-bottom: 40px; }
        h1 { font-size: 28px; margin-bottom: 10px; font-weight: 600; }
        .subtitle { color: #666; font-size: 14px; }

        .upload-section {
            background: var(--color-surface);
            border-radius: 8px;
            padding: 40px 20px;
            margin-bottom: 30px;
            border: 2px dashed var(--color-border);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--color-primary);
            background-color: #f9f9f9;
        }

        .upload-section.dragover {
            background-color: #e3f2fd;
            border-color: var(--color-primary);
        }

        .upload-icon { font-size: 48px; margin-bottom: 15px; }
        .upload-text { font-size: 16px; margin-bottom: 8px; color: var(--color-text); }
        .upload-hint { font-size: 13px; color: #999; margin-bottom: 20px; }
        #fileInput { display: none; }

        .btn {
            display: inline-block; padding: 10px 24px; border-radius: 6px; border: none;
            font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.3s ease;
        }
        .btn-primary { background-color: var(--color-primary); color: white; margin: 0 8px; }
        .btn-primary:hover {
            background-color: #1976D2; transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.4);
        }
        .btn-secondary { background-color: var(--color-success); color: white; }
        .btn-secondary:hover { background-color: #45a049; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }

        .file-list {
            margin-top: 20px; padding: 15px; background-color: #f9f9f9;
            border-radius: 6px; display: none;
        }
        .file-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px 0; border-bottom: 1px solid var(--color-border); font-size: 13px;
        }
        .file-item:last-child { border-bottom: none; }
        .file-name { color: var(--color-text); font-weight: 500; }
        .file-size { color: #999; font-size: 12px; }
        .remove-file {
            color: var(--color-error); cursor: pointer; font-size: 12px;
            font-weight: 600; padding: 4px 8px; border-radius: 4px; transition: background-color 0.2s;
        }
        .remove-file:hover { background-color: rgba(244, 67, 54, 0.1); }

        .results-section {
            background: var(--color-surface); border-radius: 8px; padding: 30px;
            margin-bottom: 30px; display: none;
        }
        .results-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 25px; padding-bottom: 15px; border-bottom: 2px solid var(--color-border);
        }
        .results-title { font-size: 20px; font-weight: 600; }

        .stats { display: flex; gap: 30px; margin-bottom: 30px; flex-wrap: wrap; }
        .stat-item {
            flex: 1; min-width: 150px; padding: 15px;
            background: #f5f5f5; border-radius: 6px;
        }
        .stat-label {
            font-size: 12px; color: #666; text-transform: uppercase;
            font-weight: 600; margin-bottom: 5px;
        }
        .stat-value { font-size: 28px; font-weight: 700; color: var(--color-primary); }

        .table-container { overflow-x: auto; border-radius: 6px; border: 1px solid var(--color-border); }
        table { width: 100%; border-collapse: collapse; background: white; }
        th {
            background-color: #f5f5f5; padding: 12px 10px; text-align: center;
            font-weight: 600; font-size: 13px; border: 1px solid var(--color-border);
            color: var(--color-text); white-space: nowrap;
        }
        th:first-child { text-align: left; background-color: #eeeeee; min-width: 150px; }
        td {
            padding: 12px 10px; text-align: center; border: 1px solid var(--color-border);
            font-size: 13px; font-weight: 500;
        }
        td:first-child { text-align: left; background-color: #fafafa; font-weight: 600; color: var(--color-text); }

        .color-cell { color: white; font-weight: 600; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }

        .color-legend {
            margin-top: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 6px;
        }
        .legend-title { font-weight: 600; margin-bottom: 15px; font-size: 14px; }
        .legend-bar {
            height: 20px; border-radius: 4px;
            background: linear-gradient(to right, #c8e6c9 0%, #a5d6a7 20%, #81c784 40%, #ffd54f 60%, #ffb74d 75%, #ef5350 90%, #c62828 100%);
            margin-bottom: 10px;
        }
        .legend-labels { display: flex; justify-content: space-between; font-size: 12px; color: #666; }

        .error-message {
            background-color: #ffebee; border: 1px solid #ef5350; color: #c62828;
            padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;
        }
        .success-message {
            background-color: #e8f5e9; border: 1px solid #4caf50; color: #2e7d32;
            padding: 15px; border-radius: 6px; margin-bottom: 20px; display: none;
        }

        .loading { text-align: center; padding: 40px; color: #666; display: none; }
        .spinner {
            border: 3px solid #f3f3f3; border-top: 3px solid var(--color-primary);
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 0 auto 15px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .footer { text-align: center; color: #999; font-size: 12px; margin-top: 50px; }

        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            h1 { font-size: 22px; }
            .results-header { flex-direction: column; align-items: flex-start; }
            .stats { gap: 15px; }
            table { font-size: 12px; }
            th, td { padding: 8px 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“Š DCA Trading Analysis</h1>
            <p class="subtitle">Log íŒŒì¼ì„ ì—…ë¡œë“œí•˜ì—¬ DCA ìµì ˆ í˜„í™©ì„ ë¶„ì„í•˜ì„¸ìš” (ëŒ€ìš©ëŸ‰ íŒŒì¼ ì§€ì›)</p>
        </header>

        <div class="upload-section" id="uploadSection">
            <div class="upload-icon">ğŸ“</div>
            <div class="upload-text">ì—¬ê¸°ì— íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­í•˜ì—¬ ì—…ë¡œë“œ</div>
            <div class="upload-hint">ì§€ì› í˜•ì‹: .log, .txt (GBë‹¨ìœ„ ëŒ€ìš©ëŸ‰ íŒŒì¼ ê°€ëŠ¥)</div>
            <button class="btn btn-primary" id="selectFileBtn">íŒŒì¼ ì„ íƒ</button>
            <input type="file" id="fileInput" multiple accept=".log,.txt">
        </div>

        <div class="file-list" id="fileList">
            <div style="font-weight: 600; margin-bottom: 10px;">ì„ íƒëœ íŒŒì¼:</div>
            <div id="fileItems"></div>
        </div>

        <div class="error-message" id="errorMessage"></div>
        <div class="success-message" id="successMessage"></div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">ë°ì´í„° ë¶„ì„ ì¤‘...</p>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="results-header">
                <div class="results-title">ë¶„ì„ ê²°ê³¼</div>
                <button class="btn btn-secondary" id="exportBtn">ğŸ“¥ Excelë¡œ ë‹¤ìš´ë¡œë“œ</button>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">ì´ ìµì ˆ íšŸìˆ˜</div>
                    <div class="stat-value" id="totalTakeProfit">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ì´ ê·¸ë£¹ ìˆ˜</div>
                    <div class="stat-value" id="totalGroups">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ìµœëŒ€ DCA ë‹¨ê³„</div>
                    <div class="stat-value" id="maxDCAStep">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">í‰ê·  DCA ë‹¨ê³„</div>
                    <div class="stat-value" id="avgDCAStep">0</div>
                </div>
            </div>

            <div class="table-container">
                <table id="resultTable">
                    <thead id="tableHead"></thead>
                    <tbody id="tableBody"></tbody>
                </table>
            </div>

            <div class="color-legend">
                <div class="legend-title">ìƒ‰ìƒ ë²”ë¡€ (ë¡œê·¸í•¨ìˆ˜ ê¸°ë°˜ ê·¸ë˜ë””ì–¸íŠ¸)</div>
                <div class="legend-bar"></div>
                <div class="legend-labels">
                    <span>ìµœì†Œ</span><span>ë‚®ìŒ</span><span>ì¤‘ê°„</span><span>ë†’ìŒ</span><span>ìµœëŒ€</span>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>Â© 2026 DCA Trading Analysis Tool | GitHub Pages</p>
        </div>
    </div>

    <script>
        let selectedFiles = [];
        let analysisData = {};
        let currentMaxDCA = 0;
        let currentGroupMap = {};
        
        // [ë°±ì—”ë“œ] ë©”ëª¨ë¦¬ ìµœì í™”ë¥¼ ìœ„í•œ Chunk Size ì„¤ì • (5MB)
        const CHUNK_SIZE = 5 * 1024 * 1024;

        // UI ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const selectFileBtn = document.getElementById('selectFileBtn');

        selectFileBtn.addEventListener('click', () => fileInput.click());

        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.classList.add('dragover');
        });

        uploadSection.addEventListener('dragleave', () => {
            uploadSection.classList.remove('dragover');
        });

        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.classList.remove('dragover');
            handleFiles(e.dataTransfer.files);
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateFileList();

            if (selectedFiles.length > 0) {
                // UI ë Œë”ë§ í›„ ë¶„ì„ ì‹œì‘
                setTimeout(analyzeFiles, 300);
            }
        }

        function updateFileList() {
            const fileList = document.getElementById('fileList');
            const fileItems = document.getElementById('fileItems');

            if (selectedFiles.length === 0) {
                fileList.style.display = 'none';
                return;
            }

            fileList.style.display = 'block';
            fileItems.innerHTML = selectedFiles.map((file, index) => `
                <div class="file-item">
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size / 1024 / 1024).toFixed(2)} MB</div>
                    </div>
                    <div class="remove-file" onclick="removeFile(${index})">ì œê±°</div>
                </div>
            `).join('');
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileList();
            if (selectedFiles.length === 0) {
                document.getElementById('resultsSection').style.display = 'none';
            }
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = 'âŒ ' + message;
            errorDiv.style.display = 'block';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = 'âœ… ' + message;
            successDiv.style.display = 'block';
            setTimeout(() => { successDiv.style.display = 'none'; }, 3000);
        }

        // [ë°±ì—”ë“œ] ìŠ¤íŠ¸ë¦¼ ë°©ì‹ì˜ DCA ë¡œê·¸ íŒŒì„œ í´ë˜ìŠ¤ (ìœ ì—°í•œ Regex ì ìš©)
        class StreamDCAParser {
            constructor() {
                this.matches = [];
                // [ìˆ˜ì •] ìœ ì—°í•œ ì •ê·œì‹: ì•ë¶€ë¶„(â–¡)ì´ë‚˜ í¬ë§·(USDT ìœ„ì¹˜ ë“±)ì— êµ¬ì• ë°›ì§€ ì•Šê³  PROFIT, GROUP, DCAë§Œ ì¶”ì¶œ
                // ì˜ˆ: "PROFIT [BTC] ... GROUP : BTC - DCA : 1" í˜•íƒœë„ ë§¤ì¹­ ê°€ëŠ¥
                this.pattern = /(?:PROFIT|ìµì ˆ).*?GROUP\s*:\s*(.*?)\s+-\s+DCA\s*:\s*(\d+)/i;
            }

            parseLine(line) {
                // ë¹ ë¥¸ í•„í„°ë§: PROFIT(ë˜ëŠ” ìµì ˆ)ê³¼ GROUPì´ ì—†ëŠ” ë¼ì¸ì€ íŒ¨ìŠ¤
                if ((!line.includes("PROFIT") && !line.includes("ìµì ˆ")) || !line.includes("GROUP")) return;

                const match = this.pattern.exec(line);
                if (match) {
                    this.matches.push({
                        group: match[1].trim(), // ê·¸ë£¹ëª… ì¶”ì¶œ
                        dca: parseInt(match[2]) // DCA ë‹¨ê³„ ì¶”ì¶œ
                    });
                }
            }

            getResult() {
                if (this.matches.length === 0) return null;
                return {
                    data: this.matches,
                    count: this.matches.length
                };
            }
        }

        // [ë°±ì—”ë“œ] í•µì‹¬ ë¶„ì„ í•¨ìˆ˜ (Chunk ì²˜ë¦¬ + ë©”ëª¨ë¦¬ ë³´í˜¸)
        async function analyzeFiles() {
            const loadingDiv = document.getElementById('loading');
            const loadingText = document.getElementById('loadingText');
            
            loadingDiv.style.display = 'block';
            analysisData = {}; // ë°ì´í„° ì´ˆê¸°í™”

            const files = selectedFiles;
            
            // ì¬ê·€ì  íŒŒì¼ ì²˜ë¦¬ í•¨ìˆ˜ (ìˆœì°¨ ì²˜ë¦¬ë¡œ ë©”ëª¨ë¦¬ ì•ˆì •ì„± í™•ë³´)
            const processNextFile = (fileIndex) => {
                if (fileIndex >= files.length) {
                    finishAnalysis();
                    return;
                }

                const file = files[fileIndex];
                const fileSize = file.size;
                let offset = 0;
                let chunkReader = new FileReader();
                let leftover = "";
                let parser = new StreamDCAParser();

                chunkReader.onload = function(e) {
                    const chunkText = e.target.result;
                    e.target.result = null; // [ì¤‘ìš”] ì½ì€ ì›ë³¸ ë©”ëª¨ë¦¬ ì¦‰ì‹œ í•´ì œ

                    let data = leftover + chunkText;
                    let lastNewlineIndex = 0;
                    let nextNewlineIndex = 0;

                    // ë¼ì¸ ë‹¨ìœ„ ìˆ˜ë™ íŒŒì‹± (split ì‚¬ìš© ì•ˆ í•¨)
                    while ((nextNewlineIndex = data.indexOf('\n', lastNewlineIndex)) > -1) {
                        // ë¬¸ìì—´ ê°•ì œ ë³µì‚¬ë¡œ ì›ë³¸ ì°¸ì¡° ëŠê¸° (V8 Memory Leak ë°©ì§€)
                        const rawLine = data.substring(lastNewlineIndex, nextNewlineIndex);
                        const line = (' ' + rawLine).slice(1);

                        if (line.trim().length > 0) {
                            parser.parseLine(line);
                        }
                        lastNewlineIndex = nextNewlineIndex + 1;
                    }

                    // ì²˜ë¦¬ë˜ì§€ ì•Šì€ ë‚˜ë¨¸ì§€ (ë§ˆì§€ë§‰ ì¤„) ì €ì¥
                    leftover = (' ' + data.substring(lastNewlineIndex)).slice(1);
                    data = null; // [ì¤‘ìš”] ì²˜ë¦¬ëœ ë°ì´í„° ë³€ìˆ˜ í•´ì œ

                    offset += CHUNK_SIZE;

                    // ì§„í–‰ë¥  í‘œì‹œ ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ìŠ¤í”¼ë„ˆ ì•„ë˜ì— í…ìŠ¤íŠ¸ ì¶”ê°€)
                    const percent = Math.min(100, Math.round((offset / fileSize) * 100));
                    loadingText.textContent = `ë¶„ì„ ì¤‘... íŒŒì¼ ${fileIndex + 1}/${files.length} (${percent}%)`;

                    if (offset < fileSize) {
                        // 0ms ë”œë ˆì´ë¡œ ìŠ¤íƒ ë¹„ìš°ê¸° (GC ê¸°íšŒ ì œê³µ)
                        setTimeout(readNextChunk, 0);
                    } else {
                        // íŒŒì¼ ë ì²˜ë¦¬
                        if (leftover.trim().length > 0) parser.parseLine(leftover);
                        
                        // ê²°ê³¼ ì €ì¥
                        const result = parser.getResult();
                        if (result) {
                            analysisData[file.name] = result;
                        }

                        // ë³€ìˆ˜ ëª…ì‹œì  ì´ˆê¸°í™”
                        parser = null;
                        chunkReader = null;
                        leftover = null;

                        // ë‹¤ìŒ íŒŒì¼ ì²˜ë¦¬ ì „ ì ê¹ ëŒ€ê¸° (ë¸Œë¼ìš°ì € ì‘ë‹µì„± í™•ë³´)
                        setTimeout(() => processNextFile(fileIndex + 1), 300);
                    }
                };

                chunkReader.onerror = () => {
                    showError(`${file.name} ì½ê¸° ì‹¤íŒ¨`);
                    processNextFile(fileIndex + 1); // ì—ëŸ¬ë‚˜ë„ ë‹¤ìŒ íŒŒì¼ë¡œ ì§„í–‰
                };

                const readNextChunk = () => {
                    const slice = file.slice(offset, offset + CHUNK_SIZE);
                    chunkReader.readAsText(slice, 'UTF-8');
                };

                // ì²« ì²­í¬ ì‹œì‘
                readNextChunk();
            };

            // ë¶„ì„ ì‹œì‘
            processNextFile(0);
        }

        function finishAnalysis() {
            document.getElementById('loading').style.display = 'none';

            if (Object.keys(analysisData).length === 0) {
                showError('ë¶„ì„í•  ìˆ˜ ìˆëŠ” ìµì ˆ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•˜ì„¸ìš”.');
                return;
            }

            renderResults();
            showSuccess(`${selectedFiles.length}ê°œ íŒŒì¼ ë¶„ì„ ì™„ë£Œ!`);
        }

        // --- ê¸°ì¡´ UI/ë¡œì§ (ìƒ‰ìƒ ê³„ì‚°, í…Œì´ë¸” ë Œë”ë§, ì—‘ì…€ ë‹¤ìš´ë¡œë“œ) ---

        function getCommonColor(value, minVal, maxVal) {
            if (value === 0) return { hex: 'CCCCCC', rgb: 'rgba(200, 200, 200, 0.3)' };
            if (minVal === maxVal) return { hex: 'EF5350', rgb: '#ef5350' };

            const logMin = Math.log(minVal + 1);
            const logMax = Math.log(maxVal + 1);
            const logVal = Math.log(value + 1);
            const normalizedValue = (logVal - logMin) / (logMax - logMin);

            let r, g, b;
            if (normalizedValue < 0.3) {
                const t = normalizedValue / 0.3;
                r = Math.round(165 + (255 - 165) * t);
                g = 214;
                b = Math.round(167 + (79 - 167) * t);
            } else if (normalizedValue < 0.7) {
                const t = (normalizedValue - 0.3) / 0.4;
                r = 255;
                g = Math.round(214 + (180 - 214) * t);
                b = Math.round(79 + (0 - 79) * t);
            } else {
                const t = (normalizedValue - 0.7) / 0.3;
                r = 255;
                g = Math.round(180 + (0 - 180) * t);
                b = 0;
            }

            const toHex = (c) => c.toString(16).padStart(2, '0').toUpperCase();
            return {
                hex: `${toHex(r)}${toHex(g)}${toHex(b)}`,
                rgb: `rgb(${r}, ${g}, ${b})`
            };
        }

        function renderResults() {
            const allData = [];
            for (const fileName in analysisData) {
                allData.push(...analysisData[fileName].data);
            }

            const groupMap = {};
            let maxDCA = 0;

            allData.forEach(item => {
                if (!groupMap[item.group]) groupMap[item.group] = {};
                if (!groupMap[item.group][item.dca]) groupMap[item.group][item.dca] = 0;
                groupMap[item.group][item.dca]++;
                maxDCA = Math.max(maxDCA, item.dca);
            });

            currentMaxDCA = maxDCA;
            currentGroupMap = groupMap;

            const totalTakeProfit = allData.length;
            const totalGroups = Object.keys(groupMap).length;
            const avgDCA = totalTakeProfit > 0 ? (allData.reduce((sum, item) => sum + item.dca, 0) / totalTakeProfit).toFixed(2) : 0;

            document.getElementById('totalTakeProfit').textContent = totalTakeProfit;
            document.getElementById('totalGroups').textContent = totalGroups;
            document.getElementById('maxDCAStep').textContent = maxDCA;
            document.getElementById('avgDCAStep').textContent = avgDCA;

            generateTable(groupMap, maxDCA);

            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('fileList').style.display = 'none';
        }

        function generateTable(groupMap, maxDCA) {
            const thead = document.getElementById('tableHead');
            const tbody = document.getElementById('tableBody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            const headerRow = document.createElement('tr');
            headerRow.innerHTML = '<th>ê·¸ë£¹ëª…</th>';
            for (let i = 0; i <= maxDCA; i++) {
                const th = document.createElement('th');
                th.textContent = `${i} DCA`;
                headerRow.appendChild(th);
            }
            const thTotal = document.createElement('th');
            thTotal.textContent = 'Total';
            headerRow.appendChild(thTotal);
            thead.appendChild(headerRow);

            const allValues = [];
            const rows = [];
            for (const group in groupMap) {
                let rowTotal = 0;
                const rowData = [];
                for (let i = 0; i <= maxDCA; i++) {
                    const value = groupMap[group][i] || 0;
                    rowData.push(value);
                    rowTotal += value;
                    if (value > 0) allValues.push(value);
                }
                rows.push({ group, data: rowData, total: rowTotal });
            }
            rows.sort((a, b) => b.total - a.total);

            const minVal = Math.min(...allValues);
            const maxVal = Math.max(...allValues);

            rows.forEach(row => {
                const tr = document.createElement('tr');
                const tdGroup = document.createElement('td');
                tdGroup.textContent = row.group;
                tr.appendChild(tdGroup);

                row.data.forEach(value => {
                    const td = document.createElement('td');
                    if (value > 0) {
                        const color = getCommonColor(value, minVal, maxVal);
                        td.classList.add('color-cell');
                        td.style.backgroundColor = color.rgb;
                        td.textContent = value;
                    } else {
                        td.textContent = '-';
                        td.style.color = '#ccc';
                    }
                    tr.appendChild(td);
                });

                const tdTotal = document.createElement('td');
                tdTotal.style.fontWeight = '700';
                tdTotal.style.backgroundColor = '#f0f0f0';
                tdTotal.textContent = row.total;
                tr.appendChild(tdTotal);
                tbody.appendChild(tr);
            });
        }

        async function exportToExcel() {
            if (Object.keys(currentGroupMap).length === 0) {
                showError('ë‚´ë³´ë‚¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const workbook = new ExcelJS.Workbook();
                const worksheet = workbook.addWorksheet('DCA Summary');

                const headers = ['ê·¸ë£¹ëª…'];
                for (let i = 0; i <= currentMaxDCA; i++) {
                    headers.push(`${i} DCA`);
                }
                headers.push('Total');

                const headerRow = worksheet.addRow(headers);
                headerRow.eachCell((cell) => {
                    cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE0E0E0' } };
                    cell.font = { bold: true, size: 11 };
                    cell.alignment = { vertical: 'middle', horizontal: 'center' };
                    cell.border = {
                        top: { style: 'thin' }, left: { style: 'thin' },
                        bottom: { style: 'thin' }, right: { style: 'thin' }
                    };
                });

                const allValues = [];
                const rows = [];
                for (const group in currentGroupMap) {
                    let rowTotal = 0;
                    const rowData = [];
                    for (let i = 0; i <= currentMaxDCA; i++) {
                        const value = currentGroupMap[group][i] || 0;
                        rowData.push(value);
                        rowTotal += value;
                        if (value > 0) allValues.push(value);
                    }
                    rows.push({ group, data: rowData, total: rowTotal });
                }
                rows.sort((a, b) => b.total - a.total);

                const minVal = Math.min(...allValues);
                const maxVal = Math.max(...allValues);

                rows.forEach(rowData => {
                    const rowValues = [rowData.group, ...rowData.data, rowData.total];
                    const row = worksheet.addRow(rowValues);

                    row.eachCell((cell, colNumber) => {
                        cell.border = {
                            top: { style: 'thin' }, left: { style: 'thin' },
                            bottom: { style: 'thin' }, right: { style: 'thin' }
                        };
                        cell.alignment = { vertical: 'middle', horizontal: 'center' };

                        if (colNumber === 1) {
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF9F9F9' } };
                            cell.alignment = { vertical: 'middle', horizontal: 'left' };
                        } else if (colNumber > 1 && colNumber <= headers.length - 1) {
                            const val = cell.value;
                            if (val > 0) {
                                const color = getCommonColor(val, minVal, maxVal);
                                cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF' + color.hex } };
                                cell.font = { color: { argb: 'FFFFFFFF' }, bold: true };
                            } else {
                                cell.value = '-';
                                cell.font = { color: { argb: 'FFCCCCCC' } };
                            }
                        } else if (colNumber === headers.length) {
                            cell.font = { bold: true };
                            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F0F0' } };
                        }
                    });
                });

                worksheet.columns.forEach((column, i) => {
                    let maxLength = 0;
                    column.eachCell({ includeEmpty: true }, (cell) => {
                        const columnLength = cell.value ? cell.value.toString().length : 10;
                        if (columnLength > maxLength) maxLength = columnLength;
                    });
                    column.width = maxLength < 10 ? 10 : maxLength + 2;
                });

                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
                const url = window.URL.createObjectURL(blob);
                const anchor = document.createElement('a');
                anchor.href = url;
                anchor.download = `DCA_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
                anchor.click();
                window.URL.revokeObjectURL(url);

                showSuccess('Excel íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (error) {
                console.error('Excel ë‚´ë³´ë‚´ê¸° ì˜¤ë¥˜:', error);
                showError('Excel ë‚´ë³´ë‚´ê¸° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        document.getElementById('exportBtn').addEventListener('click', exportToExcel);
    </script>
</body>
</html>
