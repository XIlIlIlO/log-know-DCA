<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>DCA 익절 요약 분석기</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.bundle.js"></script>
    <style>
        body { font-family: sans-serif; padding: 20px; line-height: 1.6; }
        .container { max-width: 800px; margin: 0 auto; border: 1px solid #ddd; padding: 20px; border-radius: 8px; }
        input[type="file"] { margin-bottom: 20px; }
        button { padding: 10px 20px; background-color: #4CAF50; color: white; border: none; cursor: pointer; border-radius: 4px; }
        button:hover { background-color: #45a049; }
        #status { margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>DCA Profit 로그 분석기</h2>
    <p>로그 파일(.log 또는 .txt)들을 선택하세요. 여러 개 선택 가능합니다.</p>
    <input type="file" id="fileInput" multiple accept=".log,.txt" />
    <br>
    <button onclick="processFiles()">엑셀 생성 및 다운로드</button>
    <div id="status"></div>
</div>

<script>
async function processFiles() {
    const fileInput = document.getElementById('fileInput');
    const status = document.getElementById('status');
    
    if (fileInput.files.length === 0) {
        alert("파일을 선택해주세요.");
        return;
    }

    status.innerText = "파일 분석 중...";
    
    let rawData = [];
    let maxDca = 0;
    let groups = new Set();

    // 1. 모든 파일 읽기 및 데이터 추출
    for (let file of fileInput.files) {
        const text = await file.text();
        // 정규식: 그룹명과 DCA 차수 추출 (JS에 맞게 수정)
        const pattern = /□ PROFIT \[[\s\S]*?\] [\s\S]*? USDT\s*\n\s*\n- GROUP : (.*?)-\n- DCA : (\d+)\//g;
        
        let match;
        while ((match = pattern.exec(text)) !== null) {
            const groupName = match[1].trim();
            const dcaStep = parseInt(match[2]);
            rawData.push({ group: groupName, dca: dcaStep });
            groups.add(groupName);
            if (dcaStep > maxDca) maxDca = dcaStep;
        }
    }

    if (rawData.length === 0) {
        status.innerText = "데이터를 찾을 수 없습니다. 로그 형식을 확인하세요.";
        return;
    }

    // 2. 피벗 데이터 생성 (행: DCA, 열: Group)
    const sortedGroups = Array.from(groups).sort();
    const pivotTable = [];

    // 각 DCA 차수별(0 ~ maxDca) 행 생성
    for (let d = 0; d <= maxDca; d++) {
        let row = { "DCA Step": d + " DCA" };
        let rowTotal = 0;
        sortedGroups.forEach(g => {
            const count = rawData.filter(item => item.group === g && item.dca === d).length;
            row[g] = count;
            rowTotal += count;
        });
        row["Total"] = rowTotal;
        pivotTable.push(row);
    }

    // 3. 색상 계산 함수 (Logarithmic Scale)
    // 연두색(90EE90) -> 빨간색(FF0000)
    function getColor(value, min, max) {
        if (value === 0) return "FFFFFF";
        if (max === min) return "FF0000";
        
        // 로그 스케일 적용: 수치가 작을 때 변화가 더 크게 느껴지도록 함
        const logVal = Math.log(value + 1);
        const logMin = Math.log(min + 1);
        const logMax = Math.log(max + 1);
        const ratio = (logVal - logMin) / (logMax - logMin);

        // RGB 보간 (LightGreen: 144, 238, 144 -> Red: 255, 0, 0)
        const r = Math.round(144 + (255 - 144) * ratio);
        const g = Math.round(238 + (0 - 238) * ratio);
        const b = Math.round(144 + (0 - 144) * ratio);
        
        return ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1).toUpperCase();
    }

    const allCounts = pivotTable.flatMap(row => sortedGroups.map(g => row[g])).filter(v => v > 0);
    const minVal = Math.min(...allCounts);
    const maxVal = Math.max(...allCounts);

    // 4. 엑셀 워크시트 생성
    const wsData = [];
    // 헤더 행
    wsData.push(["DCA 차수", ...sortedGroups, "Total"]);

    // 데이터 행
    pivotTable.forEach(row => {
        let excelRow = [row["DCA Step"]];
        sortedGroups.forEach(g => excelRow.push(row[g]));
        excelRow.push(row["Total"]);
        wsData.push(excelRow);
    });

    const ws = XLSX.utils.aoa_to_sheet(wsData);

    // 5. 스타일 적용 (색상)
    const range = XLSX.utils.decode_range(ws['!ref']);
    for (let r = 1; r <= range.e.r; r++) { // 헤더 제외 데이터부터
        for (let c = 1; c < range.e.c; c++) { // 첫 열(DCA)과 마지막 열(Total) 제외
            const cellAddress = XLSX.utils.encode_cell({ r: r, c: c });
            if (!ws[cellAddress]) continue;
            
            const val = ws[cellAddress].v;
            if (typeof val === 'number' && val > 0) {
                const bgColor = getColor(val, minVal, maxVal);
                ws[cellAddress].s = {
                    fill: { fgColor: { rgb: bgColor } },
                    alignment: { horizontal: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                };
            }
        }
    }

    // 6. 파일 다운로드
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "DCA Summary");
    XLSX.writeFile(wb, "dca_summary_report.xlsx");

    status.innerText = `완료! 총 ${rawData.length}건의 익절 분석됨.`;
}
</script>

</body>
</html>
